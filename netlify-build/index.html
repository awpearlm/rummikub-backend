<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rummikub Online - Play with Friends... NO YOU PLAY WITH ME!</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Rummikub">
    <meta name="description" content="Play the classic tile-laying game with Jillian and have her yell at you when you win!">
    
        <link rel="stylesheet" href="styles.css?v=51">
    <link rel="stylesheet" href="connection-status.css?v=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="screen active">
        <!-- Profile Bubble (replaces old logout container) -->
        <div class="profile-bubble">
            <div class="profile-avatar">
                <span id="profileInitial">?</span>
            </div>
            <div class="profile-info">
                <div class="profile-username" id="profileUsername">Guest</div>
                <div class="profile-connection-status" id="profileConnectionStatus">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Connecting...</span>
                </div>
            </div>
            <button id="adminButton" class="profile-admin-btn" title="Admin Dashboard" style="display: none;">
                <i class="fas fa-crown"></i>
            </button>
            <button id="logoutButton" class="profile-logout-btn" title="Log out">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
        
        <div class="welcome-container">
            <div class="game-header">
                <h1><i class="fas fa-chess-board"></i> J-kube Online</h1>
                <p>Play the classic tile-laying game with Jillian and have her yell at you when you win!</p>
            </div>
            
            <div class="welcome-form">
            <!---
                <div class="form-group game-options">
                    <div class="timer-option">
                        <label class="option-label">
                            <input type="checkbox" id="enableTimer" checked>
                            <span class="option-text"><i class="fas fa-clock"></i> Enable Turn Timer (2 mins)</span>
                        </label>
                    </div>
                </div>
            -->
                <div class="game-mode-selection">
                    <h3><i class="fas fa-gamepad"></i> Choose Game Mode</h3>
                    <div class="mode-buttons">
                        <button id="playWithBotBtn" class="btn btn-mode btn-bot">
                            <i class="fas fa-robot"></i>
                            <div class="mode-info">
                                <strong>Play vs Computer</strong>
                                <span>Practice against AI opponent</span>
                            </div>
                        </button>
                        <button id="playWithFriendsBtn" class="btn btn-mode btn-friends">
                            <i class="fas fa-users"></i>
                            <div class="mode-info">
                                <strong>Play with Friends</strong>
                                <span>Create or join multiplayer games</span>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Multiplayer Options (hidden by default) -->
                <div id="multiplayerOptions" class="multiplayer-options hidden">
                    <!-- Game Lobby -->
                    <div class="game-lobby-section">
                        <h3><i class="fas fa-list"></i> Available Games</h3>
                        <div id="gamesList" class="games-list-container">
                            <div class="loading-games"><i class="fas fa-spinner fa-spin"></i> Loading available games...</div>
                        </div>
                        <div class="lobby-actions">
                            <button id="createGameBtn" class="btn btn-refresh">
                                <i class="fas fa-plus"></i> Create New Game
                            </button>
                            <button id="joinGameBtn" class="btn btn-refresh">
                                <i class="fas fa-sign-in-alt"></i> Join with Code
                            </button>
                            <button id="refreshGamesBtn" class="btn btn-refresh">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div id="joinGameForm" class="join-form hidden">
                        <div class="form-group">
                            <label for="gameId">Game Code</label>
                            <input type="text" id="gameId" placeholder="Enter game code" maxlength="6">
                        </div>
                        <button id="joinGameSubmit" class="btn btn-primary">Join Game</button>
                    </div>
                </div>
                
                <!-- Bot Game Options (hidden by default) -->
                <div id="botGameOptions" class="bot-options hidden">
                    <div class="difficulty-selection">
                        <label for="botDifficulty">Bot Difficulty</label>
                        <select id="botDifficulty" class="difficulty-select">
                            <option value="easy">Easy - Friendly Bot</option>
                            <option value="medium" selected>Medium - Challenging Bot</option>
                            <option value="hard">Hard - Expert Bot</option>
                            <option value="debug">ðŸ”§ Debug Mode - Custom Hand</option>
                            <option value="lastTile">ðŸ§ª Last Tile Test - 4 Tile Hand</option>
                        </select>
                    </div>
                    <div class="difficulty-selection">
                        <label for="botCount">Number of Bots</label>
                        <select id="botCount" class="difficulty-select">
                            <option value="1" selected>1 Bot (2 players total)</option>
                            <option value="2">2 Bots (3 players total)</option>
                            <option value="3">3 Bots (4 players total)</option>
                        </select>
                    </div>
                    <button id="startBotGameBtn" class="btn btn-success">
                        <i class="fas fa-play"></i> Start Game vs Bot
                    </button>
                </div>
            </div>
            
            <!-- Leaderboard -->
            <div class="leaderboard">
                <h3><i class="fas fa-trophy"></i> Top Players</h3>
                <div class="leaderboard-content">
                    <div class="leaderboard-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading leaderboard...
                    </div>
                    <div class="leaderboard-list" id="leaderboardList" style="display: none;">
                        <!-- Leaderboard entries will be populated by JavaScript -->
                    </div>
                    <div class="leaderboard-error" id="leaderboardError" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Unable to load leaderboard
                    </div>
                </div>
            </div>
            
            <div class="game-rules">
                <h3><i class="fas fa-info-circle"></i> How to Play</h3>
                <ul>
                    <li>Create sets of 3+ tiles: same number different colors, or consecutive numbers same color</li>
                    <li>First play must be worth 30+ points</li>
                    <li>Draw a tile if you can't play, then end your turn</li>
                    <li>First player to empty their hand wins! Bonus: If it's not Jillian, you probably cheated!</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div class="game-container">
            <!-- Game Header -->
            <div class="game-header-bar">
                <div class="game-info">
                    <h2>Game: <span id="currentGameId"></span> <button id="copyGameIdBtn" class="btn btn-sm btn-light" title="Copy game code to clipboard"><i class="fas fa-copy"></i></button></h2>
                    <div class="turn-indicator">
                        <span id="currentTurnPlayer">Waiting...</span>'s turn
                        <div id="turnTimer" class="turn-timer hidden">
                            <i class="fas fa-clock"></i> <span id="timerDisplay">2:00</span>
                        </div>
                    </div>
                </div>
                
                <div class="players-info">
                    <div id="playersList" class="players-list-horizontal"></div>
                </div>
                
                <div class="game-status-header">
                    <div class="deck-info">
                        <i class="fas fa-layer-group"></i>
                        <span id="deckCount">106</span> tiles left
                    </div>
                </div>
                
                <div class="game-actions">
                    <div id="startButtonContainer" class="start-game-container">
                        <button id="startGameBtn" class="btn btn-success hidden">
                            <i class="fas fa-play"></i> Start Game
                        </button>
                    </div>
                    <button id="leaveGameBtn" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> Leave
                    </button>
                </div>
            </div>

            <div class="game-layout">
                <!-- Game Board -->
                <div class="game-board">
                    <div id="gameBoard" class="board-area">
                        <div class="board-placeholder">
                            <i class="fas fa-chess-board"></i>
                            <p>Played sets will appear here</p>
                        </div>
                    </div>
                    <!-- Start game button moved to header -->
                </div>
            </div>

            <!-- Player Hand -->
            <div class="player-hand-section">
                <!-- Game Log Button -->
                <button id="gameLogBtn" class="game-log-btn">
                    <i class="fas fa-history"></i>
                </button>
                
                <!-- Game Log Modal -->
                <div id="gameLogModal" class="game-log-modal">
                    <div class="game-log-scrim"></div>
                    <div class="game-log">
                        <div class="game-log-header">
                            <h4><i class="fas fa-history"></i> Game Log</h4>
                            <button id="closeGameLogBtn" class="close-game-log-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="gameLogMessages" class="game-log-messages"></div>
                    </div>
                </div>
                
                <div class="hand-header">
                    <div class="hand-actions">
                        <div class="action-buttons">
                            <button id="playSetBtn" class="btn btn-success">
                                <i class="fas fa-play"></i> Play Selected
                            </button>
                            <button id="drawTileBtn" class="btn btn-warning">
                                <i class="fas fa-plus"></i> Draw
                            </button>
                            <button id="undoBtn" class="btn btn-secondary" disabled title="Undo last move">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button id="endTurnBtn" class="btn btn-info">
                                <i class="fas fa-forward"></i> End Turn
                            </button>
                            <button id="refreshGameBtn" class="btn btn-danger hidden" title="Refresh game state to recover from stuck games">
                                <i class="fas fa-sync"></i> Refresh Game
                            </button>
                        </div>
                        <div class="sort-buttons">
                            <button id="sortByColorBtn" class="btn btn-secondary btn-small">
                                <i class="fas fa-palette"></i>
                            </button>
                            <button id="sortByNumberBtn" class="btn btn-secondary btn-small">
                                <i class="fas fa-sort-numeric-up"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="hand-content">
                    <div id="playerHand" class="player-hand">
                        <div class="hand-placeholder">
                            <p>Your tiles will appear here when the game starts</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen">
        <div class="loading-container">
            <div class="loading-spinner">
                <i class="fas fa-chess-board fa-spin"></i>
            </div>
            <p>Connecting to game...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Connection Lost Overlay -->
    <div id="connectionLostOverlay" class="connection-lost-overlay" style="display: none;">
        <div class="connection-lost-content">
            <h2><i class="fas fa-exclamation-triangle"></i> Connection Lost</h2>
            <p>We're having trouble connecting to the game server. This could be due to internet issues or server maintenance.</p>
            <div id="reconnectionStatus">Attempting to reconnect automatically...</div>
            <p class="reconnect-info">You don't have any saved games. Clicking the button below will refresh the page.</p>
            <button id="manualReconnectBtn" class="reconnect-button">
                <i class="fas fa-sync-alt"></i> Refresh Page
            </button>
        </div>
    </div>

    <!-- Game Pause Overlay -->
    <div id="gamePauseOverlay" class="game-pause-overlay" style="display: none;">
        <div class="pause-overlay-scrim"></div>
        <div class="pause-overlay-content">
            <div class="pause-header">
                <div class="pause-icon">
                    <i class="fas fa-pause-circle"></i>
                </div>
                <h2 id="pauseTitle">Game Paused</h2>
                <p id="pauseReason">Waiting for player to reconnect...</p>
            </div>
            
            <div class="pause-info">
                <div id="gracePeriodSection" class="grace-period-section">
                    <div class="grace-period-timer">
                        <div class="timer-circle">
                            <div class="timer-text">
                                <span id="gracePeriodTimer">3:00</span>
                                <small>remaining</small>
                            </div>
                        </div>
                    </div>
                    <p class="grace-period-text">
                        Waiting for <strong id="disconnectedPlayerName">Player</strong> to reconnect...
                    </p>
                </div>
                
                <div id="continuationOptionsSection" class="continuation-options-section" style="display: none;">
                    <h3>What would you like to do?</h3>
                    <p class="options-description">The disconnected player hasn't returned. Choose how to continue:</p>
                    
                    <div class="continuation-options">
                        <button id="skipTurnOption" class="continuation-option">
                            <div class="option-icon">
                                <i class="fas fa-forward"></i>
                            </div>
                            <div class="option-content">
                                <h4>Skip Turn</h4>
                                <p>Skip the disconnected player's turn and continue with remaining players</p>
                            </div>
                        </button>
                        
                        <button id="addBotOption" class="continuation-option">
                            <div class="option-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="option-content">
                                <h4>Add Bot Player</h4>
                                <p>Replace the disconnected player with an AI bot</p>
                            </div>
                        </button>
                        
                        <button id="endGameOption" class="continuation-option">
                            <div class="option-icon">
                                <i class="fas fa-stop-circle"></i>
                            </div>
                            <div class="option-content">
                                <h4>End Game</h4>
                                <p>End the current game and return to the main menu</p>
                            </div>
                        </button>
                    </div>
                    
                    <div id="votingStatus" class="voting-status" style="display: none;">
                        <p>Waiting for other players to vote...</p>
                        <div class="voting-progress">
                            <div class="progress-bar">
                                <div id="votingProgressBar" class="progress-fill"></div>
                            </div>
                            <span id="votingProgressText">0/0 votes</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Victory Celebration -->
    <div id="victoryOverlay" class="victory-overlay hidden">
        <div class="confetti-container">
            <!-- Confetti particles will be generated here -->
        </div>
        <div class="victory-message">
            <div class="trophy-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <h1 id="winnerName">Winner!</h1>
            <p>Congratulations on your victory!</p>
            <div class="victory-buttons">
                <button id="playAgainBtn" class="btn btn-primary victory-btn">
                    <i class="fas fa-redo"></i> Play Again
                </button>
                <button id="cancelBtn" class="btn btn-secondary victory-btn">
                    <i class="fas fa-times"></i> Back to Menu
                </button>
            </div>
        </div>
    </div>

    <!-- Turn Notification Overlay :) -->
    <div id="turnNotificationOverlay" class="turn-notification-overlay hidden">
        <div class="notification-scrim"></div>
        <div class="turn-notification-card">
            <div class="notification-icon">
                <i class="fas fa-play-circle"></i>
            </div>
            <h2 id="turnNotificationPlayerName">Your Turn!</h2>
            <p>Make your move now</p>
        </div>
    </div>
    
    <!-- Game Settings Modal -->
    <div id="gameSettingsModal" class="game-settings-modal">
        <div class="modal-scrim"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Game Settings</h3>
                <button id="closeSettingsBtn" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-container">
                    <div class="setting-option">
                        <label class="setting-label">
                            <input type="checkbox" id="settingsEnableTimer" checked>
                            <span class="setting-text"><i class="fas fa-clock"></i> Enable Turn Timer (2 mins)</span>
                        </label>
                    </div>
                    <!-- More settings can be added here in the future -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelSettingsBtn" class="btn btn-secondary">Cancel</button>
                <button id="createGameWithSettingsBtn" class="btn btn-primary">Go to my game</button>
                <button id="createBotGameWithSettingsBtn" class="btn btn-success" style="display: none;">
                    <i class="fas fa-robot"></i> Start Bot Game
                </button>
            </div>
        </div>
    </div>

    <script>
        // Authentication check on page load
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('auth_token');
            const username = localStorage.getItem('username');
            
            if (!token || !username) {
                // Not authenticated - redirect to login page
                window.location.href = 'login.html';
            }
        });
    </script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="safe-events.js?v=1"></script>
    <script src="js/connectionRecovery.js?v=1"></script>
    <script src="js/mobileTouch.js?v=1"></script>
    <script src="js/mobileOptimizations.js?v=1"></script>
            <script src="game.js"></script>
</body>
</html>
